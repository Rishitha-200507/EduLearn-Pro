<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ course['title'] }} - EduLearn Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">EduLearn Pro</a>
            <div class="navbar-nav ms-auto">
                <a href="/dashboard" class="nav-link">Back to Dashboard</a>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row">
            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    {% if course['thumbnail'] %}
                    <img src="{{ url_for('static', filename='uploads/' + course['thumbnail']) }}" class="card-img-top" alt="Thumbnail">
                    {% else %}
                    <div class="card-body bg-secondary text-white text-center py-5">
                        <p>No Image Available</p>
                    </div>
                    {% endif %}
                    
                    <div class="card-body">
                        <h2 class="card-title">{{ course['title'] }}</h2>
                        <p class="card-text">{{ course['description'] }}</p>
                        <hr>
                        <h5>Instructor</h5>
                        <p class="text-muted">ID: {{ course['instructor_id'] }}</p>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                
                {% set total_lessons = lessons|length %}
                {% set completed_count = completed_lesson_ids|length %}
                
                {% if total_lessons > 0 %}
                    {% set progress = (completed_count / total_lessons * 100)|round|int %}
                {% else %}
                    {% set progress = 0 %}
                {% endif %}
                
                {% if session.get('role') == 'student' %}
                    <div class="card shadow-sm mb-4 p-4 border-0 bg-white">
                        <h5 class="mb-3 fw-bold text-primary">Your Learning Progress: {{ progress }}%</h5>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
                                 id="studentProgressBar" 
                                 role="progressbar" 
                                 data-width="{{ progress }}%" 
                                 aria-valuenow="{{ progress }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {% if progress > 0 %}{{ progress }}%{% endif %}
                            </div>
                        </div>
                        <p class="text-muted mt-2 mb-0">{{ completed_count }} of {{ total_lessons }} lessons completed</p>
                        
                        {% if progress == 100 %}
                            <hr class="mt-4">
                            <a href="{{ url_for('certificate', course_id=course['id']) }}" class="btn btn-warning btn-lg w-100 fw-bold shadow">
                                üèÜ Claim Your Certificate
                            </a>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3>Lessons</h3>
                        {% if session.get('user_id') == course['instructor_id'] %}
                            <a href="{{ url_for('add_lesson', course_id=course['id']) }}" class="btn btn-success">+ Add Lesson</a>
                        {% endif %}
                    </div>
                {% endif %}

                {% if lessons %}
                    <div class="accordion" id="lessonsAccordion">
                        {% for lesson in lessons %}
                        
                        {% set is_completed = lesson['id'] in completed_lesson_ids %}
                        
                        {% if is_completed %}
                            {% set border_class = 'success' %}
                            {% set text_class = 'bg-light text-success fw-bold' %}
                        {% else %}
                            {% set border_class = 'secondary' %}
                            {% set text_class = '' %}
                        {% endif %}
                        
                        <div class="accordion-item mb-3 shadow-sm rounded border-{{ border_class }}">
                            
                            <h2 class="accordion-header" id="heading{{ loop.index }}">
                                <div class="d-flex align-items-center justify-content-between w-100">
                                    <button class="accordion-button collapsed {{ text_class }}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                                        Lesson {{ loop.index }}: {{ lesson['title'] }} 
                                        {% if is_completed %} <span class="ms-2">‚úÖ</span> {% endif %}
                                    </button>

                                    {% if session.get('user_id') == course['instructor_id'] %}
                                        <form action="{{ url_for('delete_lesson', lesson_id=lesson['id']) }}" method="POST" class="ms-2 me-2" onsubmit="return confirm('Delete this lesson?');">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" style="z-index: 5; position: relative;">
                                                &#128465; 
                                            </button>
                                        </form>
                                    {% endif %}
                                </div>
                            </h2>

                            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#lessonsAccordion">
                                <div class="accordion-body">
                                    <p>{{ lesson['content'] }}</p>
                                    
                                    {% if 'youtube' in lesson['video_url'] or 'youtu.be' in lesson['video_url'] %}
                                        {% set video_id = '' %}
                                        {% if 'v=' in lesson['video_url'] %}
                                            {% set video_id = lesson['video_url'].split('v=')[1].split('&')[0] %}
                                        {% elif 'youtu.be/' in lesson['video_url'] %}
                                            {% set video_id = lesson['video_url'].split('youtu.be/')[1].split('?')[0] %}
                                        {% endif %}

                                        {% if video_id %}
                                            <div class="ratio ratio-16x9 mt-3">
                                                <iframe src="https://www.youtube.com/embed/{{ video_id }}" allowfullscreen></iframe>
                                            </div>
                                        {% else %}
                                            <div class="alert alert-warning mt-3">Invalid YouTube Link</div>
                                        {% endif %}
                                    {% else %}
                                        <a href="{{ lesson['video_url'] }}" target="_blank" class="btn btn-primary mt-3">Watch Video</a>
                                    {% endif %}

                                    {% if session.get('user_id') == course['instructor_id'] %}
                                        <hr class="mt-4">
                                        <a href="{{ url_for('add_quiz', lesson_id=lesson['id']) }}" class="btn btn-warning fw-bold w-100">üìù Add a Quiz to this Lesson</a>
                                    {% endif %}

                                    {% if session.get('role') == 'student' %}
                                        <hr class="mt-4">
                                        <div class="d-grid gap-2">
                                            <a href="{{ url_for('take_quiz', lesson_id=lesson['id']) }}" class="btn btn-primary fw-bold">üéì Take Quiz</a>
                                            
                                            {% if not is_completed %}
                                                <form action="{{ url_for('complete_lesson', lesson_id=lesson['id']) }}" method="POST">
                                                    <button type="submit" class="btn btn-success w-100 fw-bold">Mark as Complete ‚úîÔ∏è</button>
                                                </form>
                                            {% else %}
                                                <div class="alert alert-success text-center mb-0 fw-bold">
                                                    ‚úÖ You have completed this lesson!
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endif %}

                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">No lessons added yet.</div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var pBar = document.getElementById("studentProgressBar");
            if(pBar) {
                pBar.style.width = pBar.getAttribute("data-width");
            }
        });
    </script>
</body>
</html>